name: CD - Release and Publish to PyPI

on:
  workflow_dispatch:

jobs:
  semantic-release:
    name: Semantic Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
    outputs:
      released: ${{ steps.semantic-release.outputs.new_release_published }}
      version: ${{ steps.semantic-release.outputs.new_release_version }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.ref }}
      
      - name: Semantic Release
        id: semantic-release
        uses: cycjimmy/semantic-release-action@v6.0.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          semantic_version: 24.2.0
          extra_plugins: |
            @semantic-release/changelog@6.0.3
            @semantic-release/exec@6.0.3
            @semantic-release/git@10.0.1
          branches: |
            [
              'master'
            ]

  build_wheels:
    name: Build wheels on ${{ matrix.os }}
    needs: semantic-release
    if: needs.semantic-release.outputs.released == 'true'
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.ref }}
          
      - name: Build wheels
        uses: pypa/cibuildwheel@v3.3.0
        env:
          CIBW_BUILD: cp310-* cp311-* cp312-* cp313-* cp314-*
          CIBW_SKIP: "*-musllinux_* pp* *-win32"
          CIBW_BEFORE_BUILD_LINUX: yum install -y libjpeg-turbo-devel || apt-get install -y libjpeg-turbo8-dev
          CIBW_BEFORE_BUILD_MACOS: brew install jpeg-turbo
          CIBW_BEFORE_BUILD_WINDOWS: vcpkg install libjpeg-turbo:x64-windows && vcpkg integrate install
          CIBW_ARCHS_MACOS: auto
          CIBW_ENVIRONMENT_MACOS: MACOSX_DEPLOYMENT_TARGET=15.0
          CIBW_ENVIRONMENT_WINDOWS: VCPKG_ROOT=C:/vcpkg
              
      - uses: actions/upload-artifact@v4
        with:
          name: wheels-${{ matrix.os }}
          path: ./wheelhouse/*.whl

  build_sdist:
    name: Build source distribution
    needs: semantic-release
    if: needs.semantic-release.outputs.released == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.ref }}
      
      - name: Install libjpeg-turbo
        run: |
          sudo apt-get update
          sudo apt-get install -y libjpeg-turbo8-dev
      
      - name: Install Python dependencies
        run: pip install numpy
      
      - name: Build sdist
        run: pipx run build --sdist
      
      - uses: actions/upload-artifact@v4
        with:
          name: sdist
          path: dist/*.tar.gz

  pypi-publish:
    name: Publish to PyPI
    needs: [build_wheels, build_sdist, semantic-release]
    if: needs.semantic-release.outputs.released == 'true'
    runs-on: ubuntu-latest
    permissions:
      id-token: write
    
    steps:
      - uses: actions/download-artifact@v4
        with:
          pattern: "*"
          merge-multiple: true
          path: dist
      
      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1